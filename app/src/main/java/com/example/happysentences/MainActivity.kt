package com.example.happysentences

import android.os.Bundle
import android.speech.tts.TextToSpeech
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.platform.LocalContext
import java.util.Locale

class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContent {
            MaterialTheme {
                Surface(modifier = Modifier.fillMaxSize()) {
                    HappySentencesScreen()
                }
            }
        }
    }
}

@Composable
private fun HappySentencesScreen() {
    val context = LocalContext.current

    var input by remember { mutableStateOf("") }
    var gentle by remember { mutableStateOf("") }
    var clear by remember { mutableStateOf("") }
    var brave by remember { mutableStateOf("") }
    var isGenerated by remember { mutableStateOf(false) }

    // TTS
    var tts by remember { mutableStateOf<TextToSpeech?>(null) }
    var ttsReady by remember { mutableStateOf(false) }

    DisposableEffect(Unit) {
        tts = TextToSpeech(context) { status ->
            if (status == TextToSpeech.SUCCESS) {
                tts?.language = Locale.KOREAN
                tts?.setSpeechRate(1.0f)
                ttsReady = true
            } else {
                ttsReady = false
            }
        }

        onDispose {
            tts?.stop()
            tts?.shutdown()
            tts = null
        }
    }

    fun briefInput(t: String, maxLen: Int = 32): String {
        val x = t.trim()
        if (x.length <= maxLen) return x
        // Îã®Ïñ¥ Í≤ΩÍ≥Ñ ÎπÑÏä∑ÌïòÍ≤å Ï≤òÎ¶¨(Ï§ëÍ∞Ñ ÏûòÎ¶º ÏµúÏÜåÌôî)
        val cut = x.lastIndexOf(' ', startIndex = maxLen).takeIf { it >= 8 } ?: maxLen
        return x.substring(0, cut).trim() + "‚Ä¶"
    }

    fun detectMood(t: String): String {
        val s = t.lowercase()
        return when {
            s.contains("ÏßúÏ¶ù") || s.contains("Ìôî") || s.contains("Ïó¥Î∞õ") || s.contains("Îπ°") -> "irritated"
            s.contains("Î∂àÏïà") || s.contains("Í±±Ï†ï") || s.contains("Ï¥àÏ°∞") -> "anxious"
            s.contains("Ïö∞Ïö∏") || s.contains("Î¨¥Í∏∞Î†•") || s.contains("ÌóàÎ¨¥") -> "low"
            s.contains("Ïô∏Î°≠") || s.contains("Ïì∏Ïì∏") -> "lonely"
            s.contains("ÌîºÍ≥§") || s.contains("ÏßÄÏ≥§") || s.contains("ÌûòÎì§") -> "tired"
            s.contains("Í∏∞ÎåÄ") || s.contains("ÏÑ§Î†ò") || s.contains("Ï¢ãÏïÑ") || s.contains("Í∏∞Î∂Ñ") -> "good"
            s.contains("ÎøåÎìØ") || s.contains("ÏûòÌñà") || s.contains("ÏÑ±Í≥µ") -> "proud"
            else -> "neutral"
        }
    }

    fun generateLocally(text: String) {
        val trimmed = text.trim()
        if (trimmed.isEmpty()) return

        val mood = detectMood(trimmed)
        val brief = briefInput(trimmed)

        // ‚úÖ Í≥µÍ∞ê ÌîÑÎ¶¨ÌîΩÏä§: 3Ï§Ñ Î™®Îëê Í≥µÍ∞êÏúºÎ°ú ÏãúÏûëÌïòÍ≤å Í∞ïÏ†ú
        val empath: String = when (mood) {
            "irritated" -> "ÏßúÏ¶ùÏù¥ ÎÇ† ÎßåÌïú ÏÉÅÌô©Ïù¥ÏóàÎÑ§Ïöî."
            "anxious" -> "Í±±Ï†ïÏù¥ Ïò¨ÎùºÏò¨ ÎßåÌïú ÏùºÏù¥ÏóàÎÑ§Ïöî."
            "tired" -> "Ïò§ÎäòÏùÄ ÎßéÏù¥ ÏßÄÏπú ÎÇ†Ïù¥ÎÑ§Ïöî."
            "low" -> "Í∏∞Î∂ÑÏù¥ Í∞ÄÎùºÏïâÏùÑ ÎßåÌïú ÎÇ†Ïù¥ÎÑ§Ïöî."
            "lonely" -> "ÌòºÏûê Î≤ÑÌã∞Îäî ÎäêÎÇåÏù¥ Îì§ ÎßåÌïú ÎÇ†Ïù¥ÎÑ§Ïöî."
            "good" -> "Í∏∞Î∂ÑÏù¥ Ï¢ãÏïÑÏßÑ Ïù¥Ïú†Í∞Ä Î∂ÑÎ™ÖÌûà ÏûàÎÑ§Ïöî."
            "proud" -> "Ïò§Îäò Ïä§Ïä§Î°ú ÎøåÎìØÌï† ÎßåÌïú ÏùºÏù¥ ÏûàÏóàÎÑ§Ïöî."
            else -> "Ïò§Îäò ÎßàÏùåÏù¥ Î≥µÏû°Ìï¥Ïßà ÎßåÌñàÎÑ§Ïöî."
        }

        // ‚úÖ ÏûÖÎ†•ÏùÑ "Í∑∏ÎåÄÎ°ú ÎÅºÏõå ÎÑ£Îäî" ÎäêÎÇåÏùÑ Ï§ÑÏù¥Îêò, ÎÇ¥Í∞Ä Ïì¥ ÎßêÏù¥ Î∞òÏòÅÎêòÍ≤å 1Î≤àÎßå Ïù∏Ïö©
        val quote = "\"$brief\""

        when (mood) {
            "good" -> {
                gentle = "$empath $quote Ïù¥Îü∞ ÏàúÍ∞ÑÏùÄ Í∑∏ÎåÄÎ°ú Ï¶êÍ≤®ÎèÑ Îê©ÎãàÎã§."
                clear = "$empath Ïò§Îäò Ï¢ãÏïòÎçò Ìè¨Ïù∏Ìä∏Î•º Ìïú Ï§ÑÎ°úÎßå ÎÇ®Í≤®ÎëêÎ©¥ Îçî Ïò§Îûò Í∞ëÎãàÎã§."
                brave = "$empath ÎÇ¥ÏùºÎèÑ ÎπÑÏä∑ÌïòÍ≤å Í∏∞Î∂Ñ Ï¢ãÏïÑÏßà Ïàò ÏûàÍ≤å, Ïâ¨Ïö¥ ÏïΩÏÜç 1Í∞úÎßå Ï†ïÌï¥Î≥ºÍπåÏöî?"
            }
            "irritated" -> {
                gentle = "$empath $quote Í∑∏Îü¥ Ïàò ÏûàÏäµÎãàÎã§."
                clear = "$empath Í∑∏ÎûòÏÑú ÏßÄÍ∏àÏùÄ ÌåêÎã®ÏùÑ ÎØ∏Î£®Í≥†, Í∞ÄÏû• ÏûëÏùÄ Í≤ÉÎ∂ÄÌÑ∞ Ï†ïÎ¶¨Ìï¥ÎèÑ Îê©ÎãàÎã§."
                brave = "$empath Í∑∏ÎûòÏÑú Î¨º Ìïú Î™®Í∏àÎßå ÎßàÏãúÍ≥†, Ìï† Ïùº 1Í∞úÎßå Ï†ÅÏñ¥Î≥¥Í≤†ÏäµÎãàÎã§."
            }
            "anxious" -> {
                gentle = "$empath $quote ÏßÄÍ∏àÏùÄ Ïà®Î∂ÄÌÑ∞ Í≥†Î•¥Î©¥ Îê©ÎãàÎã§."
                clear = "$empath Í∑∏ÎûòÏÑú 'ÏßÄÍ∏à Ìï† Ïàò ÏûàÎäî Í≤É'Îßå ÎÇ®Í∏∞Í≥†, ÎÇòÎ®∏ÏßÄÎäî ÎÇ¥ÏùºÎ°ú ÎÑòÍ∏∞Í≤†ÏäµÎãàÎã§."
                brave = "$empath Í∑∏ÎûòÏÑú Í∞ÄÏû• Ïâ¨Ïö¥ 1Îã®Í≥ÑÎßå ÌïòÍ≤†ÏäµÎãàÎã§. Ìïú Ï§ÑÎ°ú Ï†ÅÍ≥† ÌïòÎÇòÎßå ÌïòÍ≤†ÏäµÎãàÎã§."
            }
            "tired" -> {
                gentle = "$empath $quote Ïò§ÎäòÏùÄ Ïä§Ïä§Î°úÎ•º Îçî ÏïÑÍª¥ÎèÑ Îê©ÎãàÎã§."
                clear = "$empath Í∑∏ÎûòÏÑú Í∏∞Ï§ÄÏùÑ ÎÇÆÏ∂îÍ≥† 'ÏµúÏÜåÌïú'Îßå Ìï¥ÎèÑ Ï∂©Î∂ÑÌï©ÎãàÎã§."
                brave = "$empath Í∑∏ÎûòÏÑú 30Ï¥àÎßå Ïâ¨Í≥†, Îã§Ïùå ÌñâÎèô 1Í∞úÎßå Ï†ïÌïòÍ≤†ÏäµÎãàÎã§."
            }
            "low" -> {
                gentle = "$empath $quote Ïò§ÎäòÏùÄ ÏûëÏùÄ ÏúÑÎ°úÎßå ÏûàÏñ¥ÎèÑ Îê©ÎãàÎã§."
                clear = "$empath Í∑∏ÎûòÏÑú 'ÏÑ±Í≥º'Î≥¥Îã§ 'Ïú†ÏßÄ'Î•º Î®ºÏ†Ä ÎëêÍ≤†ÏäµÎãàÎã§."
                brave = "$empath Í∑∏ÎûòÏÑú ÏïÑÏ£º Ïâ¨Ïö¥ Í≤É 1Í∞úÎßå ÌïòÍ≤†ÏäµÎãàÎã§. Ï∞ΩÎ¨∏ÏùÑ Ïó¥Í≥† ÎπõÏùÑ 10Ï¥àÎßå Î≥¥Í≤†ÏäµÎãàÎã§."
            }
            "lonely" -> {
                gentle = "$empath $quote ÎßàÏùåÏùÑ Îçú Î™∞ÏïÑÎ∂ôÏù¥Í≤†ÏäµÎãàÎã§."
                clear = "$empath Í∑∏ÎûòÏÑú Ìï¥Í≤∞Î≥¥Îã§ Í∏∞Î°ùÏùÑ Î®ºÏ†Ä ÌïòÍ≤†ÏäµÎãàÎã§. Ìïú Ï§ÑÎßå Ï†ÅÏñ¥ÎèÑ Ï∂©Î∂ÑÌï©ÎãàÎã§."
                brave = "$empath Í∑∏ÎûòÏÑú ÏßßÍ≤å Ìïú Î¨∏Ïû•Îßå Î≥¥ÎÇ¥Î≥¥Í≤†ÏäµÎãàÎã§. Ïòà: Ïò§Îäò Ï¢Ä ÌûòÎì§ÏóàÏñ¥Ïöî."
            }
            "proud" -> {
                gentle = "$empath $quote Ïä§Ïä§Î°úÎ•º Ïπ≠Ï∞¨Ìï¥ÎèÑ Îê©ÎãàÎã§."
                clear = "$empath Í∑∏ÎûòÏÑú ÏûòÌïú Ï†êÏùÑ Ìïú Ï§ÑÎ°ú ÎÇ®Í≤®ÎëêÍ≤†ÏäµÎãàÎã§. Í∑∏ Í∏∞Î°ùÏù¥ ÎÇ¥ÏùºÏùò ÌûòÏù¥ Îê©ÎãàÎã§."
                brave = "$empath Í∑∏ÎûòÏÑú ÏûëÍ≤å Î≥¥ÏÉÅÌïòÍ≤†ÏäµÎãàÎã§. 5Î∂Ñ Ïâ¨Í≥† Í∏∞Î∂Ñ Ï¢ãÍ≤å ÎßàÎ¨¥Î¶¨ÌïòÍ≤†ÏäµÎãàÎã§."
            }
            else -> {
                gentle = "$empath $quote ÏßÄÍ∏àÏùÄ Ïù¥ Ï†ïÎèÑÎ°úÎèÑ Ï∂©Î∂ÑÌï©ÎãàÎã§."
                clear = "$empath Í∑∏ÎûòÏÑú ÏàúÏÑúÎ•º Ï†ïÌïòÍ≤†ÏäµÎãàÎã§. 'ÏßÄÍ∏à Ìï† Ïàò ÏûàÎäî Í≤É'Î∂ÄÌÑ∞ ÌïòÎÇòÏî© ÌïòÍ≤†ÏäµÎãàÎã§."
                brave = "$empath Í∑∏ÎûòÏÑú Í∞ÄÏû• Ïâ¨Ïö¥ Í≤É 1Í∞ÄÏßÄÎßå Ïã§ÌñâÌïòÍ≤†ÏäµÎãàÎã§."
            }
        }

        isGenerated = true
    }

    fun speak(text: String) {
        val msg = text.trim()
        if (msg.isEmpty()) return
        if (!ttsReady) return
        tts?.speak(msg, TextToSpeech.QUEUE_FLUSH, null, "HS_TTS")
    }

    Scaffold { innerPadding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(innerPadding)
                .padding(horizontal = 18.dp, vertical = 14.dp)
                .imePadding() // ÌÇ§Î≥¥Îìú Ïò¨ÎùºÏò¨ Îïå Í∞ÄÎ¶¨ÏßÄ ÏïäÍ≤å
                .navigationBarsPadding() // ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞î ÏòÅÏó≠ Í≥†Î†§
        ) {
            Text(
                text = "üòä Happy Sentences",
                modifier = Modifier.fillMaxWidth(),
                textAlign = TextAlign.Center,
                style = MaterialTheme.typography.headlineSmall.copy(fontWeight = FontWeight.Bold)
            )
            Text(
                text = "Îã®Ïñ¥Îßå Ï†ÅÏñ¥ÎèÑ Îê©ÎãàÎã§. Ïò§Îäò ÎßàÏùåÏùÑ Í∑∏ÎåÄÎ°ú Ï†ÅÏñ¥Î≥¥ÏÑ∏Ïöî.",
                modifier = Modifier.fillMaxWidth(),
                textAlign = TextAlign.Center,
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )

            Spacer(Modifier.height(10.dp))

            // Í∏∞Ï¢ÖÎ≥Ñ ÌôîÎ©¥ ÎåÄÏùë: ÏûÖÎ†•Ï∞Ω ÎÜíÏù¥Îäî "ÏµúÏÜå/ÏµúÎåÄ"Îßå Ï£ºÍ≥†, ÎÇòÎ®∏ÏßÄÎäî Í≤∞Í≥º ÏòÅÏó≠Ïù¥ Í∞ÄÏ†∏Í∞ÄÎèÑÎ°ù Ìï®
            OutlinedTextField(
                value = input,
                onValueChange = { input = it },
                modifier = Modifier
                    .fillMaxWidth()
                    .heightIn(min = 110.dp, max = 180.dp),
                placeholder = { Text("Ïòà: ÎÇ¥ÏùºÏùÄ Ïñ¥Îñ§ ÏùºÏù¥ Î≤åÏñ¥ÏßàÍπå Í∂ÅÍ∏àÌï¥") },
                maxLines = 6
            )

            Spacer(Modifier.height(10.dp))

            Row(horizontalArrangement = Arrangement.spacedBy(10.dp)) {
                Button(
                    onClick = { generateLocally(input) },
                    enabled = input.trim().isNotEmpty()
                ) {
                    Text("ÌñâÎ≥µÎ¨∏Ïû• ÎßåÎì§Í∏∞")
                }

                OutlinedButton(
                    onClick = { if (isGenerated) speak(gentle) },
                    enabled = isGenerated && ttsReady
                ) {
                    Text("ÏùΩÏñ¥Ï£ºÍ∏∞")
                }

                TextButton(
                    onClick = {
                        input = ""
                        gentle = ""
                        clear = ""
                        brave = ""
                        isGenerated = false
                    }
                ) {
                    Text("Ï¥àÍ∏∞Ìôî")
                }
            }

            Spacer(Modifier.height(10.dp))
            HorizontalDivider()
            Spacer(Modifier.height(10.dp))

            // ‚úÖ ÌïµÏã¨: Í≤∞Í≥º ÏòÅÏó≠Ïù¥ ÎÇ®ÏùÄ Í≥µÍ∞ÑÏùÑ Ï∞®ÏßÄÌïòÍ≥†(ÎπÑÏú®), ÎÇ¥Î∂Ä Ïä§ÌÅ¨Î°§(LazyColumn)Î°ú ÎÅùÍπåÏßÄ ÎÇ¥Î†§Í∞ÄÍ≤å
            LazyColumn(
                modifier = Modifier
                    .fillMaxWidth()
                    .weight(1f), // ÌôîÎ©¥ ÌÅ¨Í∏∞ÎßàÎã§ ÏûêÎèôÏúºÎ°ú Í≤∞Í≥º ÏòÅÏó≠ ÎÜíÏù¥ Ï°∞Ï†à
                verticalArrangement = Arrangement.spacedBy(12.dp),
                contentPadding = PaddingValues(bottom = 28.dp) // Îß® ÏïÑÎûò ÏûòÎ¶º Î∞©ÏßÄ Ïó¨Î∞±
            ) {
                if (isGenerated) {
                    item {
                        Text("Í≤∞Í≥º", style = MaterialTheme.typography.titleMedium)
                    }

                    item {
                        ResultCard(title = "Îã§Ï†ïÌïú Ìïú Ï§Ñ", body = gentle, onSpeak = { speak(gentle) })
                    }
                    item {
                        ResultCard(title = "ÌòÑÏã§ Ï†ïÎ¶¨ Ìïú Ï§Ñ", body = clear, onSpeak = { speak(clear) })
                    }
                    item {
                        ResultCard(title = "Ïö©Í∏∞ Ìïú Ï§Ñ", body = brave, onSpeak = { speak(brave) })
                    }
                } else {
                    // Í≤∞Í≥ºÍ∞Ä ÏóÜÏùÑ ÎïåÎèÑ ÌôîÎ©¥Ïù¥ Ïñ¥ÏÉâÌïòÏßÄ ÏïäÍ≤å ÏïàÎÇ¥Î¨∏
                    item {
                        Text(
                            text = "ÏûÖÎ†• ÌõÑ 'ÌñâÎ≥µÎ¨∏Ïû• ÎßåÎì§Í∏∞'Î•º ÎàåÎü¨Î≥¥ÏÑ∏Ïöî.",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }
            }

            if (!ttsReady) {
                Spacer(Modifier.height(8.dp))
                Text(
                    text = "ÏùåÏÑ± Ï§ÄÎπÑ Ï§ëÏù¥Í±∞ÎÇò ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.",
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        }
    }
}

@Composable
private fun ResultCard(
    title: String,
    body: String,
    onSpeak: () -> Unit
) {
    Card(modifier = Modifier.fillMaxWidth()) {
        Column(
            modifier = Modifier.padding(14.dp),
            verticalArrangement = Arrangement.spacedBy(10.dp)
        ) {
            Text(
                title,
                style = MaterialTheme.typography.titleSmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
            Text(body, style = MaterialTheme.typography.bodyLarge)
            Row(horizontalArrangement = Arrangement.spacedBy(10.dp)) {
                OutlinedButton(onClick = onSpeak) { Text("ÏùΩÍ∏∞") }
            }
        }
    }
}
